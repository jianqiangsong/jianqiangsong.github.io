<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>数据库模型 | Gemini`s wiki</title>
    
    
        <meta name="keywords" content="laravel" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="数据库模型与 Eloquent 复用或克隆query Eloquent where 日期方法 增量和减量 禁止 timestamp 列 软删除: 多行恢复 Model all: columns To Fail or not to Fail 列名修改 过滤结果集合 修改默认的Timestamp 字段 按照created_at快速排序 当创建记录时自动修改某些列的值 数据库原始查询计算运行得更快 不止">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库模型">
<meta property="og:url" content="http://example.com/2024/03/07/laravel/DB_Models_and_Eloquent/index.html">
<meta property="og:site_name" content="Gemini&#96;s wiki">
<meta property="og:description" content="数据库模型与 Eloquent 复用或克隆query Eloquent where 日期方法 增量和减量 禁止 timestamp 列 软删除: 多行恢复 Model all: columns To Fail or not to Fail 列名修改 过滤结果集合 修改默认的Timestamp 字段 按照created_at快速排序 当创建记录时自动修改某些列的值 数据库原始查询计算运行得更快 不止">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-03-07T09:34:16.874Z">
<meta property="article:modified_time" content="2025-01-08T08:59:11.226Z">
<meta property="article:author" content="Gemini">
<meta property="article:tag" content="laravel">
<meta name="twitter:card" content="summary">
    

    
        <link rel="alternate" href="/atom.xml" title="Gemini`s wiki" type="application/atom+xml" />
    

    
        <link rel="icon" href="/favicon.ico" />
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
<script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Gemini`s wiki</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
                    <a class="main-nav-link" href="/gallery">相册</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                    <td><a class="main-nav-link" href="/gallery">相册</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id='categories'>
        <h3 class="widget-title">
            <span>分类</span>
            &nbsp;
            <a id='allExpand' href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            docker
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            笔记
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/docker/docker/">docker笔记</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/2024/07/12/docker/es/">ES-docker安装部署</a></li>  <li class="file"><a href="/2024/07/18/docker/es-1/">es注意要点</a></li>  <li class="file"><a href="/2024/11/11/docker/yii2-es/">yii2-es包多条件查询</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            git
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            笔记
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E5%B7%A5%E5%85%B7/git/">git笔记</a></li>  <li class="file"><a href="/2024/04/17/%E5%B7%A5%E5%85%B7/git-tips/">git 常用笔记</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            golang
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            基础
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/golang/go/">go语言</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            laravel
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2024/03/07/laravel/Auth/">授权</a></li>  <li class="file"><a href="/2024/03/07/laravel/Artisan/">命令行工具</a></li>  <li class="file"><a href="/2024/03/07/laravel/Collections/">集合</a></li>  <li class="file"><a href="/2024/03/07/laravel/API/">api响应</a></li>  <li class="file active"><a href="/2024/03/07/laravel/DB_Models_and_Eloquent/">数据库模型</a></li>  <li class="file"><a href="/2024/03/07/laravel/Factories/">工厂</a></li>  <li class="file"><a href="/2024/03/07/laravel/Mail/">邮件</a></li>  <li class="file"><a href="/2024/03/07/laravel/Migrations/">数据库迁移</a></li>  <li class="file"><a href="/2024/03/07/laravel/Log_and_Debug/">日志与调试</a></li>  <li class="file"><a href="/2024/03/07/laravel/Other/">其他</a></li>  <li class="file"><a href="/2024/03/07/laravel/Views/">视图</a></li>  <li class="file"><a href="/2024/03/07/laravel/Routing/">路由</a></li>  <li class="file"><a href="/2024/03/07/laravel/Validation/">验证器</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            linux
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            windows wsl
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E5%B7%A5%E5%85%B7/wsl/">wsl2使用</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            基础
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/docker/linux/">linux常用基础命令</a></li>  <li class="file"><a href="/2023/07/18/docker/linux-1/">linux笔记</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            mac
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E5%B7%A5%E5%85%B7/mac/">mac</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            mongodb
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            常用
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/mongo/mongodb/">mongodb笔记</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            mysql
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            笔记
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/mysql/mysql/">mysql</a></li>  <li class="file"><a href="/2023/07/18/mysql/mysql-1/">mysql-用户-权限</a></li>  <li class="file"><a href="/2023/07/18/mysql/mysql-2/">mysql排序字段</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            openai
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            大语言模型
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/08/16/%E5%B7%A5%E5%85%B7/openai/">openai 图片使用demo</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            php
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            hyperf
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/php/laravel/">laravel 创建Facades门面</a></li>  <li class="file"><a href="/2023/07/18/php/hyperf/">hyperf</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            phpstrom
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E5%B7%A5%E5%85%B7/ps/">工具</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            yii
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/19/yii/yii/">常用代码片段</a></li>  <li class="file"><a href="/2023/07/28/yii/yii2/">yii2</a></li>  <li class="file"><a href="/2023/08/28/yii/yii3/">Yii2 行为类</a></li>  <li class="file"><a href="/2023/10/08/yii/yii2-admin/">yii2-admin</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            基础
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/20/%E5%B7%A5%E5%85%B7/link/">外链文章</a></li>  <li class="file"><a href="/2023/07/21/php/ioc/">IOC/DI</a></li>  <li class="file"><a href="/2023/08/08/php/%E5%87%BD%E6%95%B0/">函数</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            笔记
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/yii/php/">php</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            python
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            笔记
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/python/python/">python笔记</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            redis
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            笔记
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/redis/redis/">redis笔记</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            test
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2025/01/08/test/1/">测试</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            前端
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            hexo
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/08/16/%E5%B7%A5%E5%85%B7/hexo/">博客构建同步仓库</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            vue
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF/">vue笔记</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/09/27/%E5%B7%A5%E5%85%B7/linux/">linux</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            生活
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            记录
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E7%94%9F%E6%B4%BB/%E8%A3%85%E4%BF%AE-1/">汽车投诉车质网</a></li>  <li class="file"><a href="/2023/07/18/%E7%94%9F%E6%B4%BB/%E8%A3%85%E4%BF%AE/">火车方案</a></li>  <li class="file"><a href="/2023/09/28/%E7%94%9F%E6%B4%BB/%E6%88%B7%E5%A4%96%E8%A3%85%E5%A4%87-1/">户外露营装备</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/2023/08/24/test/pass/">备忘录</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            面试
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            总结
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95/">面试总结</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            项目
                        </a>
                         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            笔记
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2023/07/18/%E6%97%A5%E5%B8%B8%E9%A1%B9%E7%9B%AE%E5%A4%87%E6%B3%A8/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/">项目笔记</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                     </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-laravel/DB_Models_and_Eloquent" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/laravel/">laravel</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/laravel/" rel="tag">laravel</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2024/03/07/laravel/DB_Models_and_Eloquent/">
            <time datetime="2024-03-07T09:34:16.874Z" itemprop="datePublished">2024-03-07</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            数据库模型
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
                <div id="toc" class="toc-article">
                <strong class="toc-title">文章目录</strong>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B%E4%B8%8E-Eloquent"><span class="toc-number">1.</span> <span class="toc-text">数据库模型与 Eloquent</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%94%A8%E6%88%96%E5%85%8B%E9%9A%86query"><span class="toc-number">1.1.</span> <span class="toc-text">复用或克隆query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eloquent-where%E6%97%A5%E6%9C%9F%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">Eloquent where日期方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%92%8C%E5%87%8F%E9%87%8F"><span class="toc-number">1.3.</span> <span class="toc-text">增量和减量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2-timestamp-%E5%88%97"><span class="toc-number">1.4.</span> <span class="toc-text">禁止 timestamp 列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4-%E5%A4%9A%E8%A1%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">1.5.</span> <span class="toc-text">软删除-多行恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Model-all-columns"><span class="toc-number">1.6.</span> <span class="toc-text">Model all-columns</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#To-Fail-or-not-to-Fail"><span class="toc-number">1.7.</span> <span class="toc-text">To Fail or not to Fail</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%90%8D%E4%BF%AE%E6%94%B9"><span class="toc-number">1.8.</span> <span class="toc-text">列名修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E7%BB%93%E6%9E%9C%E9%9B%86%E5%90%88"><span class="toc-number">1.9.</span> <span class="toc-text">过滤结果集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%9A%84Timestamp-%E5%AD%97%E6%AE%B5"><span class="toc-number">1.10.</span> <span class="toc-text">修改默认的Timestamp 字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E7%85%A7created-at%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F"><span class="toc-number">1.11.</span> <span class="toc-text">按照created_at快速排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95%E6%97%B6%E8%87%AA%E5%8A%A8%E4%BF%AE%E6%94%B9%E6%9F%90%E4%BA%9B%E5%88%97%E7%9A%84%E5%80%BC"><span class="toc-number">1.12.</span> <span class="toc-text">当创建记录时自动修改某些列的值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E5%A7%8B%E6%9F%A5%E8%AF%A2%E8%AE%A1%E7%AE%97%E8%BF%90%E8%A1%8C%E5%BE%97%E6%9B%B4%E5%BF%AB"><span class="toc-number">1.13.</span> <span class="toc-text">数据库原始查询计算运行得更快</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E6%AD%A2%E4%B8%80%E4%B8%AA%E8%8C%83%E5%9B%B4"><span class="toc-number">1.14.</span> <span class="toc-text">不止一个范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%9C%80%E8%BD%AC%E6%8D%A2-Carbon"><span class="toc-number">1.15.</span> <span class="toc-text">无需转换 Carbon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E9%A6%96%E5%AD%97%E6%AF%8D%E5%88%86%E7%BB%84"><span class="toc-number">1.16.</span> <span class="toc-text">根据首字母分组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E4%B8%8D%E6%9B%B4%E6%96%B0%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5"><span class="toc-number">1.17.</span> <span class="toc-text">永不更新某个字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find-%E6%9F%A5%E8%AF%A2%E5%A4%9A%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">1.18.</span> <span class="toc-text">find () 查询多条数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find%E5%A4%9A%E4%B8%AA%E6%A8%A1%E5%9E%8B%E5%B9%B6%E8%BF%94%E5%9B%9E%E5%A4%9A%E5%88%97"><span class="toc-number">1.19.</span> <span class="toc-text">find多个模型并返回多列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E7%85%A7%E9%94%AE%E6%9F%A5%E6%89%BE"><span class="toc-number">1.20.</span> <span class="toc-text">按照键查找</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8UUID%E6%9B%BF%E6%8D%A2auto-increment"><span class="toc-number">1.21.</span> <span class="toc-text">使用UUID替换auto-increment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Laravel-%E4%B8%AD%E7%9A%84%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.22.</span> <span class="toc-text">Laravel 中的子查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E6%9F%90%E4%BA%9B%E5%88%97"><span class="toc-number">1.23.</span> <span class="toc-text">隐藏某些列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9ADB%E6%8A%A5%E9%94%99"><span class="toc-number">1.24.</span> <span class="toc-text">确定DB报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4%E4%B8%8E%E6%9F%A5%E8%AF%A2%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-number">1.25.</span> <span class="toc-text">软删除与查询构造器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL%E5%A3%B0%E6%98%8E"><span class="toc-number">1.26.</span> <span class="toc-text">SQL声明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.27.</span> <span class="toc-text">数据库事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%88%96%E5%88%9B%E5%BB%BA"><span class="toc-number">1.28.</span> <span class="toc-text">更新或创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E6%97%B6%E7%A7%BB%E9%99%A4%E7%BC%93%E5%AD%98"><span class="toc-number">1.29.</span> <span class="toc-text">保存时移除缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Created-at%E5%92%8CUpdated-at%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.30.</span> <span class="toc-text">修改Created_at和Updated_at的格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8%E5%88%B0-JSON-%E4%B8%AD"><span class="toc-number">1.31.</span> <span class="toc-text">数组类型存储到 JSON 中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.32.</span> <span class="toc-text">复制一个模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%8D%E4%BD%8E%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8"><span class="toc-number">1.33.</span> <span class="toc-text">降低内存占用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5-fillable-guarded-%E5%B9%B6%E5%BC%BA%E5%88%B6%E6%89%A7%E8%A1%8C"><span class="toc-number">1.34.</span> <span class="toc-text">忽略 $fillable&#x2F;$guarded 并强制执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E5%B1%82%E7%88%B6%E5%AD%90%E7%BA%A7%E7%BB%93%E6%9E%84"><span class="toc-number">1.35.</span> <span class="toc-text">3层父子级结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-find-%E6%9D%A5%E6%90%9C%E7%B4%A2%E6%9B%B4%E5%A4%9A%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="toc-number">1.36.</span> <span class="toc-text">使用 find() 来搜索更多的记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E6%97%B6%E6%89%A7%E8%A1%8C%E4%BB%BB%E4%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-number">1.37.</span> <span class="toc-text">失败时执行任何操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%AE%B0%E5%BD%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E5%90%A6%E5%88%99%E6%98%BE%E7%A4%BA-404"><span class="toc-number">1.38.</span> <span class="toc-text">检查记录是否存在否则显示 404</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E4%B8%BA%E5%90%A6%E6%97%B6%E4%B8%AD%E6%AD%A2"><span class="toc-number">1.39.</span> <span class="toc-text">条件语句为否时中止</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%89%8D%E6%89%A7%E8%A1%8C%E4%BB%BB%E4%BD%95%E9%A2%9D%E5%A4%96%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.40.</span> <span class="toc-text">在删除模型之前执行任何额外的操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E4%BD%A0%E9%9C%80%E8%A6%81%E5%9C%A8%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85%E4%B8%80%E4%B8%AA%E5%AD%97%E6%AE%B5"><span class="toc-number">1.41.</span> <span class="toc-text">当你需要在保存数据到数据库时自动填充一个字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E7%9A%84%E9%A2%9D%E5%A4%96%E4%BF%A1%E6%81%AF"><span class="toc-number">1.42.</span> <span class="toc-text">获取查询语句的额外信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Laravel-%E4%B8%AD%E4%BD%BF%E7%94%A8doesntExist-%E6%96%B9%E6%B3%95"><span class="toc-number">1.43.</span> <span class="toc-text">在 Laravel 中使用doesntExist()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%B8%80%E4%BA%9B%E6%A8%A1%E5%9E%8B%E7%9A%84-boot-%E6%96%B9%E6%B3%95%E4%B8%AD%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8%E4%B8%80%E4%B8%AA%E7%89%B9%E6%80%A7"><span class="toc-number">1.44.</span> <span class="toc-text">在一些模型的 boot () 方法中自动调用一个特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Laravel-%E7%9A%84-find-%E6%96%B9%E6%B3%95%EF%BC%8C%E6%AF%94%E5%8F%AA%E4%BC%A0%E4%B8%80%E4%B8%AA-ID-%E6%9B%B4%E5%A4%9A%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">1.45.</span> <span class="toc-text">Laravel 的 find () 方法，比只传一个 ID 更多的选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Laravel-%E4%B8%AD%E6%9C%89%E4%B8%A4%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E6%96%B9%E6%B3%95%E6%9D%A5%E7%A1%AE%E5%AE%9A%E4%B8%80%E4%B8%AA%E8%A1%A8%E6%98%AF%E5%90%A6%E4%B8%BA%E7%A9%BA%E8%A1%A8"><span class="toc-number">1.46.</span> <span class="toc-text">在 Laravel 中有两种常见的方法来确定一个表是否为空表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D-property-of-non-object-%E9%94%99%E8%AF%AF"><span class="toc-number">1.47.</span> <span class="toc-text">如何避免 property of non-object 错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eloquent-%E6%95%B0%E6%8D%AE%E6%94%B9%E5%8F%98%E5%90%8E%E8%8E%B7%E5%8F%96%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">1.48.</span> <span class="toc-text">Eloquent 数据改变后获取原始数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E7%A7%8D%E6%9B%B4%E7%AE%80%E5%8D%95%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.49.</span> <span class="toc-text">一种更简单创建数据库的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Query%E6%9E%84%E9%80%A0%E5%99%A8%E7%9A%84crossJoinSub%E6%96%B9%E6%B3%95"><span class="toc-number">1.50.</span> <span class="toc-text">Query构造器的crossJoinSub方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#belongsToMany%E7%9A%84%E4%B8%AD%E9%97%B4%E8%A1%A8%E5%91%BD%E5%90%8D"><span class="toc-number">1.51.</span> <span class="toc-text">belongsToMany的中间表命名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AEPivot%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F"><span class="toc-number">1.52.</span> <span class="toc-text">根据Pivot字段排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%9F%A5%E8%AF%A2%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95"><span class="toc-number">1.53.</span> <span class="toc-text">从数据库中查询一条记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E8%87%AA%E5%8A%A8%E5%88%86%E5%9D%97"><span class="toc-number">1.54.</span> <span class="toc-text">记录自动分块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E6%B8%85%E7%90%86%E8%BF%87%E6%9C%9F%E8%AE%B0%E5%BD%95%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.55.</span> <span class="toc-text">定时清理过期记录中的模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%8F%98%E7%9A%84%E6%97%A5%E6%9C%9F%E5%92%8C%E5%AF%B9%E5%AE%83%E4%BB%AC%E7%9A%84%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.56.</span> <span class="toc-text">不变的日期和对它们的强制转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#findorfail%E6%96%B9%E6%B3%95%E4%B9%9F%E6%8E%A5%E6%94%B6ids%E6%95%B0%E7%BB%84"><span class="toc-number">1.57.</span> <span class="toc-text">findorfail方法也接收ids数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E4%BD%A0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E8%87%AA%E5%8A%A8%E7%A7%BB%E9%99%A4%E6%A8%A1%E5%9E%8BprunableTrait"><span class="toc-number">1.58.</span> <span class="toc-text">从你的数据库中自动移除模型prunableTrait</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.59.</span> <span class="toc-text">日期转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%A8%A1%E5%9E%8B%E6%9B%B4%E6%96%B0%E6%8F%92%E5%85%A5"><span class="toc-number">1.60.</span> <span class="toc-text">多模型更新插入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E7%BB%93%E6%9E%9C%E9%9B%86%E4%B9%8B%E5%90%8E%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-number">1.61.</span> <span class="toc-text">过滤结果集之后获取查询构造器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E8%81%9A%E5%90%88%E8%AE%A1%E7%AE%97%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.62.</span> <span class="toc-text">选择聚合计算相关模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.63.</span> <span class="toc-text">自定义强制转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E4%B8%AD%E4%B8%8D%E8%A6%81%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.64.</span> <span class="toc-text">保存中不要触发事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%B9%B3%E5%9D%87%E5%80%BC%E6%88%96%E6%80%BB%E6%95%B0%E6%8E%92%E5%BA%8F"><span class="toc-number">1.65.</span> <span class="toc-text">基于相关模型的平均值或总数排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E4%BA%8B%E5%8A%A1%E7%BB%93%E6%9E%9C"><span class="toc-number">1.66.</span> <span class="toc-text">返回事务结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8Equery%E4%B8%AD%E7%A7%BB%E9%99%A4%E5%A4%9A%E4%B8%AA%E5%85%AC%E5%85%B1scope"><span class="toc-number">1.67.</span> <span class="toc-text">从query中移除多个公共scope</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON%E5%88%97%E5%B1%9E%E6%80%A7%E6%8E%92%E5%BA%8F"><span class="toc-number">1.68.</span> <span class="toc-text">JSON列属性排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%BB%93%E6%9E%9C%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%8D%95%E5%88%97%E7%9A%84%E5%80%BC"><span class="toc-number">1.69.</span> <span class="toc-text">从第一个结果中获取单列的值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B%E5%B1%9E%E6%80%A7%E6%98%AF%E5%90%A6%E8%A2%AB%E4%BF%AE%E6%94%B9"><span class="toc-number">1.70.</span> <span class="toc-text">检测模型属性是否被修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E5%99%A8%E4%B8%8E%E4%BF%AE%E6%94%B9%E5%99%A8%E7%9A%84%E6%96%B0%E6%96%B9%E6%B3%95"><span class="toc-number">1.71.</span> <span class="toc-text">定义访问器与修改器的新方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%A6%E5%A4%96%E4%B8%80%E7%A7%8D%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E5%99%A8%E4%B8%8E%E4%BF%AE%E6%94%B9%E5%99%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.72.</span> <span class="toc-text">另外一种定义访问器与修改器的方法</span></a></li></ol></li></ol>
                </div>
            
        
        
            <h2 id="数据库模型与-Eloquent"><a href="#数据库模型与-Eloquent" class="headerlink" title="数据库模型与 Eloquent"></a>数据库模型与 Eloquent</h2><ol>
<li><a href="#%E5%A4%8D%E7%94%A8%E6%88%96%E5%85%8B%E9%9A%86query">复用或克隆query</a></li>
<li><a href="#Eloquent-where%E6%97%A5%E6%9C%9F%E6%96%B9%E6%B3%95">Eloquent where 日期方法</a></li>
<li><a href="#%E5%A2%9E%E9%87%8F%E5%92%8C%E5%87%8F%E9%87%8F">增量和减量</a></li>
<li><a href="#%E7%A6%81%E6%AD%A2-timestamp-%E5%88%97">禁止 timestamp 列</a></li>
<li><a href="#%E8%BD%AF%E5%88%A0%E9%99%A4-%E5%A4%9A%E8%A1%8C%E6%81%A2%E5%A4%8D">软删除: 多行恢复</a></li>
<li><a href="#Model-all-columns">Model all: columns</a></li>
<li><a href="#To-Fail-or-not-to-Fail">To Fail or not to Fail</a></li>
<li><a href="#%E5%88%97%E5%90%8D%E4%BF%AE%E6%94%B9">列名修改</a></li>
<li><a href="#%E8%BF%87%E6%BB%A4%E7%BB%93%E6%9E%9C%E9%9B%86%E5%90%88">过滤结果集合</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%9A%84-Timestamp-%E5%AD%97%E6%AE%B5">修改默认的Timestamp 字段</a></li>
<li><a href="#%E6%8C%89%E7%85%A7created_at%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F">按照created_at快速排序</a></li>
<li><a href="#%E5%BD%93%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95%E6%97%B6%E8%87%AA%E5%8A%A8%E4%BF%AE%E6%94%B9%E6%9F%90%E4%BA%9B%E5%88%97%E7%9A%84%E5%80%BC">当创建记录时自动修改某些列的值</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E5%A7%8B%E6%9F%A5%E8%AF%A2%E8%AE%A1%E7%AE%97%E8%BF%90%E8%A1%8C%E5%BE%97%E6%9B%B4%E5%BF%AB">数据库原始查询计算运行得更快</a></li>
<li><a href="#%E4%B8%8D%E6%AD%A2%E4%B8%80%E4%B8%AA%E8%8C%83%E5%9B%B4">不止一个范围</a></li>
<li><a href="#%E6%97%A0%E9%9C%80%E8%BD%AC%E6%8D%A2-Carbon">无需转换 Carbon</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AE%E9%A6%96%E5%AD%97%E6%AF%8D%E5%88%86%E7%BB%84">根据首字母分组</a></li>
<li><a href="#%E6%B0%B8%E4%B8%8D%E6%9B%B4%E6%96%B0%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5">永不更新某个字段</a></li>
<li><a href="#find-()-%E6%9F%A5%E8%AF%A2%E5%A4%9A%E6%9D%A1%E6%95%B0%E6%8D%AE">find () 查询多条数据</a></li>
<li><a href="#find%E5%A4%9A%E4%B8%AA%E6%A8%A1%E5%9E%8B%E5%B9%B6%E8%BF%94%E5%9B%9E%E5%A4%9A%E5%88%97">find多个模型并返回多列</a></li>
<li><a href="#%E6%8C%89%E7%85%A7%E9%94%AE%E6%9F%A5%E6%89%BE">按照键查找</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8UUID%E6%9B%BF%E6%8D%A2auto-increment">使用UUID替换auto-increment</a></li>
<li><a href="#Laravel-%E4%B8%AD%E7%9A%84%E5%AD%90%E6%9F%A5%E8%AF%A2">Laravel 中的子查询</a></li>
<li><a href="#%E9%9A%90%E8%97%8F%E6%9F%90%E4%BA%9B%E5%88%97">隐藏某些列</a></li>
<li><a href="#%E7%A1%AE%E5%AE%9ADB%E6%8A%A5%E9%94%99">确定DB报错</a></li>
<li><a href="#%E8%BD%AF%E5%88%A0%E9%99%A4%E4%B8%8E%E6%9F%A5%E8%AF%A2%E6%9E%84%E9%80%A0%E5%99%A8">软删除与查询构造器</a></li>
<li><a href="#SQL%E5%A3%B0%E6%98%8E">SQL声明</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1">数据库事务</a></li>
<li><a href="#%E6%9B%B4%E6%96%B0%E6%88%96%E5%88%9B%E5%BB%BA">更新或创建</a></li>
<li><a href="#%E4%BF%9D%E5%AD%98%E6%97%B6%E7%A7%BB%E9%99%A4%E7%BC%93%E5%AD%98">保存时移除缓存</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9Created_at%E5%92%8CUpdated_at%E7%9A%84%E6%A0%BC%E5%BC%8F">修改Created_at和Updated_at的格式</a></li>
<li><a href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8%E5%88%B0-JSON-%E4%B8%AD">数组类型存储到 JSON 中</a></li>
<li><a href="#%E5%A4%8D%E5%88%B6%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9E%8B">复制一个模型</a></li>
<li><a href="#%E9%99%8D%E4%BD%8E%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8">降低内存占用</a></li>
<li><a href="#%E5%BF%BD%E7%95%A5-$fillable/$guarded-%E5%B9%B6%E5%BC%BA%E5%88%B6%E6%89%A7%E8%A1%8C">忽略 $fillable&#x2F;$guarded 并强制执行</a></li>
<li><a href="#3%E5%B1%82%E7%88%B6%E5%AD%90%E7%BA%A7%E7%BB%93%E6%9E%84">3层父子级结构</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-find()-%E6%9D%A5%E6%90%9C%E7%B4%A2%E6%9B%B4%E5%A4%9A%E7%9A%84%E8%AE%B0%E5%BD%95">使用 find() 来搜索更多的记录</a></li>
<li><a href="#%E5%A4%B1%E8%B4%A5%E6%97%B6%E6%89%A7%E8%A1%8C%E4%BB%BB%E4%BD%95%E6%93%8D%E4%BD%9C">失败时执行任何操作</a></li>
<li><a href="#%E6%A3%80%E6%9F%A5%E8%AE%B0%E5%BD%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E5%90%A6%E5%88%99%E6%98%BE%E7%A4%BA-404">检查记录是否存在否则显示 404</a></li>
<li><a href="#%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E4%B8%BA%E5%90%A6%E6%97%B6%E4%B8%AD%E6%AD%A2">条件语句为否时中止</a></li>
<li><a href="#%E5%9C%A8%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%89%8D%E6%89%A7%E8%A1%8C%E4%BB%BB%E4%BD%95%E9%A2%9D%E5%A4%96%E7%9A%84%E6%93%8D%E4%BD%9C">在删除模型之前执行任何额外的操作</a></li>
<li><a href="#%E5%BD%93%E4%BD%A0%E9%9C%80%E8%A6%81%E5%9C%A8%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85%E4%B8%80%E4%B8%AA%E5%AD%97%E6%AE%B5">当你需要在保存数据到数据库时自动填充一个字段</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E7%9A%84%E9%A2%9D%E5%A4%96%E4%BF%A1%E6%81%AF">获取查询语句的额外信息</a></li>
<li><a href="#%E5%9C%A8-Laravel-%E4%B8%AD%E4%BD%BF%E7%94%A8doesntExist()%E6%96%B9%E6%B3%95">在 Laravel 中使用doesntExist()方法</a></li>
<li><a href="#%E5%9C%A8%E4%B8%80%E4%BA%9B%E6%A8%A1%E5%9E%8B%E7%9A%84-boot-()-%E6%96%B9%E6%B3%95%E4%B8%AD%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8%E4%B8%80%E4%B8%AA%E7%89%B9%E6%80%A7">在一些模型的 boot () 方法中自动调用一个特性</a></li>
<li><a href="#%E5%9C%A8-Laravel-%E4%B8%AD%E6%9C%89%E4%B8%A4%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E6%96%B9%E6%B3%95%E6%9D%A5%E7%A1%AE%E5%AE%9A%E4%B8%80%E4%B8%AA%E8%A1%A8%E6%98%AF%E5%90%A6%E4%B8%BA%E7%A9%BA%E8%A1%A8">在 Laravel 中有两种常见的方法来确定一个表是否为空表</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D-property-of-non-object-%E9%94%99%E8%AF%AF">如何避免 property of non-object 错误</a></li>
<li><a href="#Eloquent-%E6%95%B0%E6%8D%AE%E6%94%B9%E5%8F%98%E5%90%8E%E8%8E%B7%E5%8F%96%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE">Eloquent 数据改变后获取原始数据</a></li>
<li><a href="#%E4%B8%80%E7%A7%8D%E6%9B%B4%E7%AE%80%E5%8D%95%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95">一种更简单创建数据库的方法</a></li>
<li><a href="#Query%E6%9E%84%E9%80%A0%E5%99%A8%E7%9A%84crossJoinSub%E6%96%B9%E6%B3%95">Query构造器的crossJoinSub方法</a></li>
<li><a href="#belongsToMany%E7%9A%84%E4%B8%AD%E9%97%B4%E8%A1%A8%E5%91%BD%E5%90%8D">belongsToMany的中间表命名</a></li>
<li><a href="#%E6%A0%B9%E6%8D%AEPivot%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F">根据Pivot字段排序</a></li>
<li><a href="#%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%9F%A5%E8%AF%A2%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95">从数据库中查询一条记录</a></li>
<li><a href="#%E8%AE%B0%E5%BD%95%E8%87%AA%E5%8A%A8%E5%88%86%E5%9D%97">记录自动分块</a></li>
<li><a href="#%E5%AE%9A%E6%97%B6%E6%B8%85%E7%90%86%E8%BF%87%E6%9C%9F%E8%AE%B0%E5%BD%95%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9E%8B">定时清理过期记录中的模型</a></li>
<li><a href="#%E4%B8%8D%E5%8F%98%E7%9A%84%E6%97%A5%E6%9C%9F%E5%92%8C%E5%AF%B9%E5%AE%83%E4%BB%AC%E7%9A%84%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2">不变的日期和对它们的强制转换</a></li>
<li><a href="#findorfail%E6%96%B9%E6%B3%95%E4%B9%9F%E6%8E%A5%E6%94%B6ids%E6%95%B0%E7%BB%84">findorfail方法也接收ids数组</a></li>
<li><a href="#%E4%BB%8E%E4%BD%A0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E8%87%AA%E5%8A%A8%E7%A7%BB%E9%99%A4%E6%A8%A1%E5%9E%8BprunableTrait">从你的数据库中自动移除模型prunableTrait</a></li>
<li><a href="#%E6%97%A5%E6%9C%9F%E8%BD%AC%E6%8D%A2">日期转换</a></li>
<li><a href="#%E5%A4%9A%E6%A8%A1%E5%9E%8B%E6%9B%B4%E6%96%B0%E6%8F%92%E5%85%A5">多模型更新&#x2F;插入</a></li>
<li><a href="#%E8%BF%87%E6%BB%A4%E7%BB%93%E6%9E%9C%E9%9B%86%E4%B9%8B%E5%90%8E%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E6%9E%84%E9%80%A0%E5%99%A8">过滤结果集之后获取查询构造器</a></li>
<li><a href="#%E9%80%89%E6%8B%A9%E8%81%9A%E5%90%88%E8%AE%A1%E7%AE%97%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9E%8B">选择聚合计算相关模型</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2">自定义强制转换</a></li>
<li><a href="#%E4%BF%9D%E5%AD%98%E4%B8%AD%E4%B8%8D%E8%A6%81%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6">保存中不要触发事件</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%B9%B3%E5%9D%87%E5%80%BC%E6%88%96%E6%80%BB%E6%95%B0%E6%8E%92%E5%BA%8F">基于相关模型的平均值或总数排序</a></li>
<li><a href="#%E8%BF%94%E5%9B%9E%E4%BA%8B%E5%8A%A1%E7%BB%93%E6%9E%9C">返回事务结果</a></li>
<li><a href="#%E4%BB%8Equery%E4%B8%AD%E7%A7%BB%E9%99%A4%E5%A4%9A%E4%B8%AA%E5%85%AC%E5%85%B1scope">从query中移除多个公共scope</a></li>
<li><a href="#JSON%E5%88%97%E5%B1%9E%E6%80%A7%E6%8E%92%E5%BA%8F">JSON列属性排序</a></li>
<li><a href="#%E4%BB%8E%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%BB%93%E6%9E%9C%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%8D%95%E5%88%97%E7%9A%84%E5%80%BC">从第一个结果中获取单列的值</a></li>
<li><a href="#%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B%E5%B1%9E%E6%80%A7%E6%98%AF%E5%90%A6%E8%A2%AB%E4%BF%AE%E6%94%B9">检测模型属性是否被修改</a></li>
<li><a href="#%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E5%99%A8%E4%B8%8E%E4%BF%AE%E6%94%B9%E5%99%A8%E7%9A%84%E6%96%B0%E6%96%B9%E6%B3%95">定义访问器与修改器的新方法</a></li>
<li><a href="#%E5%8F%A6%E5%A4%96%E4%B8%80%E7%A7%8D%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E5%99%A8%E4%B8%8E%E4%BF%AE%E6%94%B9%E5%99%A8%E7%9A%84%E6%96%B9%E6%B3%95">另外一种定义访问器与修改器的方法</a></li>
</ol>
<h3 id="复用或克隆query"><a href="#复用或克隆query" class="headerlink" title="复用或克隆query"></a>复用或克隆query</h3><p>通常，我们需要从过滤后的查询中进行更多次查询。因此，大多数时候我们使用 query() 方法，<br>让我们编写一个查询来获取今天创建的可用和不可用的产品</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$query</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">query</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$today</span> = <span class="title function_ invoke__">request</span>()-&gt;q_date ?? <span class="title function_ invoke__">today</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$today</span>)&#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="variable">$today</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让我们获取可用和不可用的产品</span></span><br><span class="line"><span class="variable">$active_products</span> = <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">get</span>(); <span class="comment">// 这一行 修改了$query 对象变量</span></span><br><span class="line"><span class="variable">$inactive_products</span> = <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="number">0</span>)-&gt;<span class="title function_ invoke__">get</span>(); <span class="comment">// 所以这里我们将获取不到任何不可用产品</span></span><br></pre></td></tr></table></figure>

<p>但是，在获得 <code>$active products</code> 后，<code>$query</code> 会被修改。因此 <code>$inactive_products</code> 不会从 <code>$query</code> 中获取到不可用产品，并且每次都返回空集合。因为，它尝试从 <code>$active_products</code> 中查找不可用产品（<code>$query</code> 仅返回可用产品）。</p>
<p>为了解决这个问题,我们可以通过重用这个<code>$query</code>对象来查询多次。因此我们在做任何对<code>$query</code>修改操作的时候需要克隆这个<code>$query</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$active_products</span> = (<span class="keyword">clone</span> <span class="variable">$query</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">get</span>(); <span class="comment">// it will not modify the $query</span></span><br><span class="line"><span class="variable">$inactive_products</span> = (<span class="keyword">clone</span> <span class="variable">$query</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="number">0</span>)-&gt;<span class="title function_ invoke__">get</span>(); <span class="comment">// so we will get inactive products from $query</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Eloquent-where日期方法"><a href="#Eloquent-where日期方法" class="headerlink" title="Eloquent where日期方法"></a>Eloquent where日期方法</h3><p>在 Eloquent 中，使用 <code>whereDay()</code>、<code>whereMonth()</code>、<code>whereYear()</code>、<code>whereDate()</code> 和 <code>whereTime()</code> 函数检查日期。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$products</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">whereDate</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;2018-01-31&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="variable">$products</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">whereMonth</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;12&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="variable">$products</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">whereDay</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;31&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="variable">$products</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">whereYear</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y&#x27;</span>))-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="variable">$products</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">whereTime</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;14:13:58&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="增量和减量"><a href="#增量和减量" class="headerlink" title="增量和减量"></a>增量和减量</h3><p>如果要增加数据库某个表中的某个列的值，只需要使用 <code>increment()</code> 函数。你不仅可以增加 1，还可以增加其他数字，如 50。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">Post</span>::<span class="title function_ invoke__">find</span>(<span class="variable">$post_id</span>)-&gt;<span class="title function_ invoke__">increment</span>(<span class="string">&#x27;view_count&#x27;</span>);</span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="variable">$user_id</span>)-&gt;<span class="title function_ invoke__">increment</span>(<span class="string">&#x27;points&#x27;</span>, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>

<h3 id="禁止-timestamp-列"><a href="#禁止-timestamp-列" class="headerlink" title="禁止 timestamp 列"></a>禁止 timestamp 列</h3><p>如果你的数据库表不包含 timestamp 字段 <code>created_at</code> 和 <code>updated_at</code>，你可以使用 <code>$timestamps = false</code> 属性指定 Eloquent 模型不使用它们。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Company</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$timestamps</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="软删除-多行恢复"><a href="#软删除-多行恢复" class="headerlink" title="软删除-多行恢复"></a>软删除-多行恢复</h3><p>使用软删除时，可以在一个句子中恢复多行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">Post</span>::<span class="title function_ invoke__">onlyTrashed</span>()-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;author_id&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">restore</span>();</span><br></pre></td></tr></table></figure>

<h3 id="Model-all-columns"><a href="#Model-all-columns" class="headerlink" title="Model all-columns"></a>Model all-columns</h3><p>当调用Eloquent’s <code>Model::all()</code>时你可以指定返回哪些列。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">all</span>([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="To-Fail-or-not-to-Fail"><a href="#To-Fail-or-not-to-Fail" class="headerlink" title="To Fail or not to Fail"></a>To Fail or not to Fail</h3><p>除了 <code>findOrFail()</code> 之外，还有 Eloquent 方法 <code>firstOrFail()</code>，如果没有找到查询记录，它将返回 <code>404</code> 页面。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;povilas@laraveldaily.com&#x27;</span>)-&gt;<span class="title function_ invoke__">firstOrFail</span>();</span><br></pre></td></tr></table></figure>

<h3 id="列名修改"><a href="#列名修改" class="headerlink" title="列名修改"></a>列名修改</h3><p>在 <code>Eloquent Query Builder</code> 中，您可以像在普通 SQL 查询中一样指定<code>as</code>以返回任何列的别名。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email as user_email&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="过滤结果集合"><a href="#过滤结果集合" class="headerlink" title="过滤结果集合"></a>过滤结果集合</h3><p>在 <code>Eloquent</code> 查询到结果之后，您可以使用 Collections 中的 <code>map()</code> 函数来修改行数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;role_id&#x27;</span>, <span class="number">1</span>)-&gt;<span class="title function_ invoke__">get</span>()-&gt;<span class="title function_ invoke__">map</span>(function (User <span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="variable">$user</span>-&gt;some_column = <span class="title function_ invoke__">some_function</span>(<span class="variable">$user</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="修改默认的Timestamp-字段"><a href="#修改默认的Timestamp-字段" class="headerlink" title="修改默认的Timestamp 字段"></a>修改默认的Timestamp 字段</h3><p>如果您使用的是非 <code>Laravel</code> 数据库并且时间戳列的名称不同怎么办？也许，你有 <code>create_time</code> 和 <code>update_time</code>。 幸运的是，您也可以在模型中指定它们：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">CREATED_AT</span> = <span class="string">&#x27;create_time&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">UPDATED_AT</span> = <span class="string">&#x27;update_time&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="按照created-at快速排序"><a href="#按照created-at快速排序" class="headerlink" title="按照created_at快速排序"></a>按照created_at快速排序</h3><p>不用:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p>你可以更快的使用排序:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">latest</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p>默认情况下 <code>latest()</code> 将按照 <code>created_at</code>排序。</p>
<p>有一个相反的方法 <code>oldest()</code>，按 created_at 升序排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">oldest</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p>您也可以指定另一列进行排序。 例如，如果你想使用 <code>updated_at</code>，你可以这样做：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$lastUpdatedUser</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">latest</span>(<span class="string">&#x27;updated_at&#x27;</span>)-&gt;<span class="title function_ invoke__">first</span>();</span><br></pre></td></tr></table></figure>

<h3 id="当创建记录时自动修改某些列的值"><a href="#当创建记录时自动修改某些列的值" class="headerlink" title="当创建记录时自动修改某些列的值"></a>当创建记录时自动修改某些列的值</h3><p>如果您想在创建记录时生成一些 DB 列值，请将其添加到模型的 boot() 方法中。<br>例如，如果您有一个字段 「position」，并且想要赋值下一个可用位置（如 Country::max(‘position’) + 1)，请执行以下操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">boot</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Country</span>::<span class="title function_ invoke__">creating</span>(function(<span class="variable">$model</span>) &#123;</span><br><span class="line">            <span class="variable">$model</span>-&gt;position = <span class="title class_">Country</span>::<span class="title function_ invoke__">max</span>(<span class="string">&#x27;position&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据库原始查询计算运行得更快"><a href="#数据库原始查询计算运行得更快" class="headerlink" title="数据库原始查询计算运行得更快"></a>数据库原始查询计算运行得更快</h3><p>使用类似 <code>whereRaw()</code> 方法的 SQL 原始查询，直接在查询中进行一些数据库特定计算，而不是在 Laravel 中，通常情况下结果会更快。 例如，如果您想获得注册后 30 天以上仍处于活跃状态的用户，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">whereRaw</span>(<span class="string">&#x27;TIMESTAMPDIFF(DAY, created_at, updated_at) &gt; ?&#x27;</span>, <span class="number">30</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="不止一个范围"><a href="#不止一个范围" class="headerlink" title="不止一个范围"></a>不止一个范围</h3><p>您可以在 Eloquent 中组合和链式调用查询范围，在一个<code>query</code>查询中使用多个范围。</p>
<p>Model文件内:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeActive</span>(<span class="params"><span class="variable">$query</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;active&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeRegisteredWithinDays</span>(<span class="params"><span class="variable">$query</span>, <span class="variable">$days</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&gt;=&#x27;</span>, <span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">subDays</span>(<span class="variable">$days</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制器内:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">registeredWithinDays</span>(<span class="number">30</span>)-&gt;<span class="title function_ invoke__">active</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="无需转换-Carbon"><a href="#无需转换-Carbon" class="headerlink" title="无需转换 Carbon"></a>无需转换 Carbon</h3><p>如果你正使用 <code>whereDate()</code> 查询今日的记录，可以直接使用 <code>Carbon</code> 的 <code>now()</code> 方法，它会自动转换为日期进行查询，而不需要指定 -&gt;toDateString()。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 不用</span></span><br><span class="line"><span class="variable">$todayUsers</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">whereDate</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">toDateString</span>())-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="comment">// 不用做转换 只需要用 now()</span></span><br><span class="line"><span class="variable">$todayUsers</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">whereDate</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="title function_ invoke__">now</span>())-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="根据首字母分组"><a href="#根据首字母分组" class="headerlink" title="根据首字母分组"></a>根据首字母分组</h3><p>你可以用任意自定义条件对 Eloquent 结果进行分组，下面的示例是由用户名的第一个单词进行分组:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">all</span>()-&gt;<span class="title function_ invoke__">groupBy</span>(function(<span class="variable">$item</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$item</span>-&gt;name[<span class="number">0</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="永不更新某个字段"><a href="#永不更新某个字段" class="headerlink" title="永不更新某个字段"></a>永不更新某个字段</h3><p>如果有一个数据库字段你想只设置一次并不想再次更新，您可以在Eloquent的模型上使用一个修改器设置该限制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setEmailAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;email) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;attributes[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="find-查询多条数据"><a href="#find-查询多条数据" class="headerlink" title="find () 查询多条数据"></a>find () 查询多条数据</h3><p><code>find()</code>方法可以接受多参数, 传入多个值时会返回所有找到记录的集合，而不是一个模型:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 返回 Eloquent Model</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 返回 Eloquent Collection</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br></pre></td></tr></table></figure>

<p>技巧来自 <a target="_blank" rel="noopener" href="https://twitter.com/tahiriqbalnajam/status/1436120403655671817">@tahiriqbalnajam</a></p>
<h3 id="find多个模型并返回多列"><a href="#find多个模型并返回多列" class="headerlink" title="find多个模型并返回多列"></a>find多个模型并返回多列</h3><p><code>find</code>方法可接受多参数 使得结果集返回指定列的模型集合，而不是模型的所有列:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Will return Eloquent Model with first_name and email only</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>, [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>]);</span><br><span class="line"><span class="comment">// Will return Eloquent Collection with first_name and email only</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">find</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>技巧来自 <a target="_blank" rel="noopener" href="https://github.com/tahiriqbalnajam">@tahiriqbalnajam</a></p>
<h3 id="按照键查找"><a href="#按照键查找" class="headerlink" title="按照键查找"></a>按照键查找</h3><p>您还可以使用<code>whereKey()</code>方法根据您指定的主键查找多条记录。(默认<code>id</code>但是你可以在Eloquent 模型中覆盖掉)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">whereKey</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="使用UUID替换auto-increment"><a href="#使用UUID替换auto-increment" class="headerlink" title="使用UUID替换auto-increment"></a>使用UUID替换auto-increment</h3><p>您不想在模型中使用自动递增 ID？</p>
<p>迁移:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">Schema</span>::<span class="title function_ invoke__">create</span>(<span class="string">&#x27;users&#x27;</span>, function (Blueprint <span class="variable">$table</span>) &#123;</span><br><span class="line">    <span class="comment">// $table-&gt;increments(&#x27;id&#x27;);</span></span><br><span class="line">    <span class="variable">$table</span>-&gt;<span class="title function_ invoke__">uuid</span>(<span class="string">&#x27;id&#x27;</span>)-&gt;<span class="title function_ invoke__">unique</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>模型:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$incrementing</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$keyType</span> = <span class="string">&#x27;string&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">boot</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title class_">User</span>::<span class="title function_ invoke__">creating</span>(function (<span class="variable">$model</span>) &#123;</span><br><span class="line">            <span class="variable">$model</span>-&gt;<span class="title function_ invoke__">setId</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setId</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;attributes[<span class="string">&#x27;id&#x27;</span>] = <span class="title class_">Str</span>::<span class="title function_ invoke__">uuid</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Laravel-中的子查询"><a href="#Laravel-中的子查询" class="headerlink" title="Laravel 中的子查询"></a>Laravel 中的子查询</h3><p>从 Laravel 6 开始，您可以在 Eloquent 语句中使用 <code>addSelect()</code>方法，对列进行一些计算。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Destination</span>::<span class="title function_ invoke__">addSelect</span>([<span class="string">&#x27;last_flight&#x27;</span> =&gt; <span class="title class_">Flight</span>::<span class="title function_ invoke__">select</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">whereColumn</span>(<span class="string">&#x27;destination_id&#x27;</span>, <span class="string">&#x27;destinations.id&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;arrived_at&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">limit</span>(<span class="number">1</span>)</span><br><span class="line">])-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="隐藏某些列"><a href="#隐藏某些列" class="headerlink" title="隐藏某些列"></a>隐藏某些列</h3><p>在进行 Eloquent 查询时，如果您想在返回中隐藏特定字段，最快捷的方法之一是在集合结果上添加 <code>-&gt;makeHidden()</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">all</span>()-&gt;<span class="title function_ invoke__">makeHidden</span>([<span class="string">&#x27;email_verified_at&#x27;</span>, <span class="string">&#x27;deleted_at&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="确定DB报错"><a href="#确定DB报错" class="headerlink" title="确定DB报错"></a>确定DB报错</h3><p>如果您想捕获 Eloquent Query 异常，请使用特定的 <code>QueryException</code> 代替默认的 <code>Exception</code> 类，您将能够获得SQL确切的错误代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Some Eloquent/SQL statement</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (\Illuminate\Database\QueryException <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getCode</span>() === <span class="string">&#x27;23000&#x27;</span>) &#123; <span class="comment">// integrity constraint violation</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">back</span>()-&gt;<span class="title function_ invoke__">withError</span>(<span class="string">&#x27;Invalid data&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="软删除与查询构造器"><a href="#软删除与查询构造器" class="headerlink" title="软删除与查询构造器"></a>软删除与查询构造器</h3><p>注意 当你用到 <code>Eloquent</code>时 软删除将会起作用，但是查询构造器不行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 将排除软删除的条目</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">all</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将不会排除软删除的条目</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">withTrashed</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将不会排除软删除的条目</span></span><br><span class="line"><span class="variable">$users</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<h3 id="SQL声明"><a href="#SQL声明" class="headerlink" title="SQL声明"></a>SQL声明</h3><p>如果你需要执行一个简单的 SQL 查询，但没有方案 —— 比如改变数据库模式中的某些东西，只需执行 DB::statement()。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">DB::<span class="title function_ invoke__">statement</span>(<span class="string">&#x27;DROP TABLE users&#x27;</span>);</span><br><span class="line">DB::<span class="title function_ invoke__">statement</span>(<span class="string">&#x27;ALTER TABLE projects AUTO_INCREMENT=123&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h3><p>如果您执行了两个数据库操作，第二个可能会出错，那么您应该回滚第一个，对吗？<br>为此，我建议使用 DB Transactions，它在 Laravel 中非常简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">DB::<span class="title function_ invoke__">transaction</span>(function () &#123;</span><br><span class="line">    DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">update</span>([<span class="string">&#x27;votes&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;posts&#x27;</span>)-&gt;<span class="title function_ invoke__">delete</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="更新或创建"><a href="#更新或创建" class="headerlink" title="更新或创建"></a>更新或创建</h3><p>如果你需要检查记录是否存在，然后更新它，或者创建一个新记录，你可以用一句话来完成 - 使用 Eloquent updateOrCreate() 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Instead of this</span></span><br><span class="line"><span class="variable">$flight</span> = <span class="title class_">Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;departure&#x27;</span>, <span class="string">&#x27;Oakland&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;destination&#x27;</span>, <span class="string">&#x27;San Diego&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">first</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$flight</span>) &#123;</span><br><span class="line">    <span class="variable">$flight</span>-&gt;<span class="title function_ invoke__">update</span>([<span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>, <span class="string">&#x27;discounted&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="variable">$flight</span> = <span class="title class_">Flight</span>::<span class="title function_ invoke__">create</span>([</span><br><span class="line">	    <span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Oakland&#x27;</span>,</span><br><span class="line">	    <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;San Diego&#x27;</span>,</span><br><span class="line">	    <span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>,</span><br><span class="line">	    <span class="string">&#x27;discounted&#x27;</span> =&gt; <span class="number">1</span></span><br><span class="line">	]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Do it in ONE sentence</span></span><br><span class="line"><span class="variable">$flight</span> = <span class="title class_">Flight</span>::<span class="title function_ invoke__">updateOrCreate</span>(</span><br><span class="line">    [<span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Oakland&#x27;</span>, <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;San Diego&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>, <span class="string">&#x27;discounted&#x27;</span> =&gt; <span class="number">1</span>]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="保存时移除缓存"><a href="#保存时移除缓存" class="headerlink" title="保存时移除缓存"></a>保存时移除缓存</h3><p>由 <a target="_blank" rel="noopener" href="https://github.com/pratiksh404">@pratiksh404</a>提供</p>
<p>如果您缓存了一个键存储了 <code>posts</code> 这个集合，想在新增或更新时移除缓存键，可以在您的模型上调用静态的 saved 函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// Forget cache key on storing or updating</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">boot</span>();</span><br><span class="line">        <span class="built_in">static</span>::<span class="title function_ invoke__">saved</span>(function () &#123;</span><br><span class="line">           <span class="title class_">Cache</span>::<span class="title function_ invoke__">forget</span>(<span class="string">&#x27;posts&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改Created-at和Updated-at的格式"><a href="#修改Created-at和Updated-at的格式" class="headerlink" title="修改Created_at和Updated_at的格式"></a>修改Created_at和Updated_at的格式</h3><p>由<a target="_blank" rel="noopener" href="https://github.com/syofyanzuhad">@syofyanzuhad</a>提供</p>
<p>想要改变 <code>created_at</code>的格式，您可以在模型中添加一个方法，如下所示:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCreatedAtFormattedAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;created_at-&gt;<span class="title function_ invoke__">format</span>(<span class="string">&#x27;H:i d, M Y&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以在需要改变时间格式时使用 <code>$entry-&gt;created_at_formatted</code> ，它会返回 <code>created_at</code> 的属性如同 <code>04:19 23, Aug 2020</code>。</p>
<p>你也可以用同样的方法更改 <code>updated_at</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUpdatedAtFormattedAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;updated_at-&gt;<span class="title function_ invoke__">format</span>(<span class="string">&#x27;H:i d, M Y&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在有需要的时候使用 <code>$entry-&gt;updated_at_formatted</code>。它会返回 <code>updated_at</code> 的属性如同: <code>04:19 23, Aug 2020</code> 。</p>
<h3 id="数组类型存储到-JSON-中"><a href="#数组类型存储到-JSON-中" class="headerlink" title="数组类型存储到 JSON 中"></a>数组类型存储到 JSON 中</h3><p>由<a target="_blank" rel="noopener" href="https://github.com/pratiksh404">@pratiksh404</a>提供</p>
<p>如果你的输入字段有一个数组需要存储为 JSON 格式，你可以在模型中使用 <code>$casts</code> 属性。 这里的 <code>images</code> 是 JSON 属性</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">    <span class="string">&#x27;images&#x27;</span> =&gt; <span class="string">&#x27;array&#x27;</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>这样你可以以 JSON 格式存储它，但当你从 DB 中读取时，它会以数组方式使用。</p>
<h3 id="复制一个模型"><a href="#复制一个模型" class="headerlink" title="复制一个模型"></a>复制一个模型</h3><p>如果你有两个非常相似的模型（比如送货地址和账单地址），而且你想要复制其中一个作为另一个，你可以使用 replicate() 方法并更改一部分属性。</p>
<p><a target="_blank" rel="noopener" href="https://laravel.com/docs/8.x/eloquent#replicating-models">官方文档的示例</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$shipping</span> = <span class="title class_">Address</span>::<span class="title function_ invoke__">create</span>([</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;shipping&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;line_1&#x27;</span> =&gt; <span class="string">&#x27;123 Example Street&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;city&#x27;</span> =&gt; <span class="string">&#x27;Victorville&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;state&#x27;</span> =&gt; <span class="string">&#x27;CA&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;postcode&#x27;</span> =&gt; <span class="string">&#x27;90001&#x27;</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$billing</span> = <span class="variable">$shipping</span>-&gt;<span class="title function_ invoke__">replicate</span>()-&gt;<span class="title function_ invoke__">fill</span>([</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;billing&#x27;</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$billing</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br></pre></td></tr></table></figure>

<h3 id="降低内存占用"><a href="#降低内存占用" class="headerlink" title="降低内存占用"></a>降低内存占用</h3><p>有时我们需要将大量的数据加载到内存中，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$orders</span> = <span class="title class_">Order</span>::<span class="title function_ invoke__">all</span>();</span><br></pre></td></tr></table></figure>

<p>但如果我们有非常庞大的数据库，这可能会很慢，因为 <code>Laravel </code> 会准备好模型类的对象。在这种情况下，<code>Laravel </code>有一个很方便的函数 <code>toBase()</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$orders</span> = <span class="title class_">Order</span>::<span class="title function_ invoke__">toBase</span>()-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="comment">//$orders 将是一个由`StdClass`组成的 `Illuminate\Support\Collection`</span></span><br></pre></td></tr></table></figure>

<p>通过调用这个方法，它将从数据库中获取数据，但它不会准备模型类。同时，向 <code>get()</code> 方法传递一个字段数组通常是个好主意，这样可以防止从数据库中获取所有字段。</p>
<h3 id="忽略-fillable-guarded-并强制执行"><a href="#忽略-fillable-guarded-并强制执行" class="headerlink" title="忽略 $fillable&#x2F;$guarded 并强制执行"></a>忽略 $fillable&#x2F;$guarded 并强制执行</h3><p>如果你为其他开发者创建了一个 Laravel 模板, 然后你不能控制他们以后会在模型的 $fillable&#x2F;$guarded 中填写什么，你可以使用 forceFill()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$team</span>-&gt;<span class="title function_ invoke__">update</span>([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;name])</span><br></pre></td></tr></table></figure>

<p>如果 name 不在<code>team</code>模型的 <code>$fillable</code> 中，怎么办？或者如果根本就没有 <code>$fillable/$guarded</code>， 怎么办？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$team</span>-&gt;<span class="title function_ invoke__">forceFill</span>([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;name])</span><br></pre></td></tr></table></figure>

<p>这将忽略该查询的 $fillable 并强制执行。</p>
<h3 id="3层父子级结构"><a href="#3层父子级结构" class="headerlink" title="3层父子级结构"></a>3层父子级结构</h3><p>If you have a 3-level structure of parent-children, like categories in an e-shop, and you want to show the number of products on the third level, you can use <code>with(&#39;yyy.yyy&#39;)</code> and then add <code>withCount()</code> as a condition</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="title">extend</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$categories</span> = <span class="title class_">Category</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">            -&gt;<span class="title function_ invoke__">whereNull</span>(<span class="string">&#x27;category_id&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">with</span>([<span class="string">&#x27;subcategories.subcategories&#x27;</span> =&gt; function(<span class="variable">$query</span>) &#123;</span><br><span class="line">                <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">withCount</span>(<span class="string">&#x27;products&#x27;</span>);</span><br><span class="line">            &#125;])-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">subcategories</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMany</span>(<span class="title class_">Category</span>::<span class="variable language_">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">products</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMany</span>(<span class="title class_">Product</span>::<span class="variable language_">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">    @<span class="keyword">foreach</span>(<span class="variable">$categories</span> <span class="keyword">as</span> <span class="variable">$category</span>)</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">            &#123;&#123; <span class="variable">$category</span>-&gt;name &#125;&#125;</span><br><span class="line">            @<span class="keyword">if</span> (<span class="variable">$category</span>-&gt;subcategories)</span><br><span class="line">                &lt;ul&gt;</span><br><span class="line">                @<span class="keyword">foreach</span>(<span class="variable">$category</span>-&gt;subcategories <span class="keyword">as</span> <span class="variable">$subcategory</span>)</span><br><span class="line">                    &lt;li&gt;</span><br><span class="line">                        &#123;&#123; <span class="variable">$subcategory</span>-&gt;name &#125;&#125;</span><br><span class="line">                        @<span class="keyword">if</span> (<span class="variable">$subcategory</span>-&gt;subcategories)</span><br><span class="line">                            &lt;ul&gt;</span><br><span class="line">                                @<span class="keyword">foreach</span> (<span class="variable">$subcategory</span>-&gt;subcategories <span class="keyword">as</span> <span class="variable">$subcategory</span>)</span><br><span class="line">                                    &lt;li&gt;&#123;&#123; <span class="variable">$subcategory</span>-&gt;name &#125;&#125; (&#123;&#123; <span class="variable">$subcategory</span>-&gt;product_count &#125;&#125;)&lt;/li&gt;</span><br><span class="line">                                @<span class="keyword">endforeach</span></span><br><span class="line">                            &lt;/ul&gt;</span><br><span class="line">                        @<span class="keyword">endif</span></span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                @<span class="keyword">endforeach</span></span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            @<span class="keyword">endif</span></span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">    @<span class="keyword">endforeach</span>           </span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>

<h3 id="使用-find-来搜索更多的记录"><a href="#使用-find-来搜索更多的记录" class="headerlink" title="使用 find() 来搜索更多的记录"></a>使用 find() 来搜索更多的记录</h3><p>你不仅可以用 find() 来搜索单条记录，还可以用 IDs 的集合来搜索更多的记录，方法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Product</span>::<span class="title function_ invoke__">whereIn</span>(<span class="string">&#x27;id&#x27;</span>, <span class="variable">$this</span>-&gt;productIDs)-&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p>这么做:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Product</span>::<span class="title function_ invoke__">find</span>(<span class="variable">$this</span>-&gt;productIDs)</span><br></pre></td></tr></table></figure>

<h3 id="失败时执行任何操作"><a href="#失败时执行任何操作" class="headerlink" title="失败时执行任何操作"></a>失败时执行任何操作</h3><p>当查询一条记录时，如果没有找到，你可能想执行一些操作。除了用 -&gt;firstOrFail() 会抛出 404 之外，你可以在失败时执行任何操作，只需要使用 </p>
<p><code>-&gt;firstOr(function() &#123; ... &#125;)</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$model</span> = <span class="title class_">Flight</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;legs&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">3</span>)-&gt;<span class="title function_ invoke__">firstOr</span>(function () &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="检查记录是否存在否则显示-404"><a href="#检查记录是否存在否则显示-404" class="headerlink" title="检查记录是否存在否则显示 404"></a>检查记录是否存在否则显示 404</h3><p>不要使用 find() ，然后再检查记录是否存在，使用 <code>findOrFail()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$product</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">find</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$product</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">abort</span>(<span class="number">404</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$product</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$productDataArray</span>);</span><br></pre></td></tr></table></figure>

<p>更简单的方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$product</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="variable">$id</span>); <span class="comment">// shows 404 if not found</span></span><br><span class="line"><span class="variable">$product</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$productDataArray</span>);</span><br></pre></td></tr></table></figure>

<h3 id="条件语句为否时中止"><a href="#条件语句为否时中止" class="headerlink" title="条件语句为否时中止"></a>条件语句为否时中止</h3><p>可以使用 <code>abort_if()</code> 作为判断条件和抛出错误页面的快捷方式。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$product</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$product</span>-&gt;user_id != <span class="title function_ invoke__">auth</span>()-&gt;<span class="title function_ invoke__">user</span>()-&gt;id)&#123;</span><br><span class="line">    <span class="title function_ invoke__">abort</span>(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更简单的方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* abort_if(CONDITION, ERROR_CODE) */</span></span><br><span class="line"><span class="variable">$product</span> = <span class="title class_">Product</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="title function_ invoke__">abort_if</span> (<span class="variable">$product</span>-&gt;user_id != <span class="title function_ invoke__">auth</span>()-&gt;<span class="title function_ invoke__">user</span>()-&gt;id, <span class="number">403</span>)</span><br></pre></td></tr></table></figure>

<h3 id="在删除模型之前执行任何额外的操作"><a href="#在删除模型之前执行任何额外的操作" class="headerlink" title="在删除模型之前执行任何额外的操作"></a>在删除模型之前执行任何额外的操作</h3><p>由<a target="_blank" rel="noopener" href="https://github.com/back2Lobby">@back2Lobby</a>提供</p>
<p>我们可以使用 <code>Model::delete()</code> 执行额外的操作来覆盖原本的删除方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// App\Models\User.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//extra steps here whatever you want</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//now perform the normal deletion</span></span><br><span class="line">	<span class="title class_">Model</span>::<span class="title function_ invoke__">delete</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="当你需要在保存数据到数据库时自动填充一个字段"><a href="#当你需要在保存数据到数据库时自动填充一个字段" class="headerlink" title="当你需要在保存数据到数据库时自动填充一个字段"></a>当你需要在保存数据到数据库时自动填充一个字段</h3><p>当你需要在保存数据到数据库时自动填充一个字段 （例如: slug），使用模型观察者来代替重复编写代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Str</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>:<span class="title function_ invoke__">boot</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">static</span>::<span class="title function_ invoke__">saving</span>(function (<span class="variable">$model</span>) &#123;</span><br><span class="line">            <span class="variable">$model</span>-&gt;slug = <span class="title class_">Str</span>::<span class="title function_ invoke__">slug</span>(<span class="variable">$model</span>-&gt;title);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由<a target="_blank" rel="noopener" href="https://twitter.com/sky_0xs/status/1432390722280427521">@sky_0xs</a>提供</p>
<h3 id="获取查询语句的额外信息"><a href="#获取查询语句的额外信息" class="headerlink" title="获取查询语句的额外信息"></a>获取查询语句的额外信息</h3><p>你可以使用 <code>explain()</code> 方法来获取查询语句的额外信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">Book</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Ruskin Bond&#x27;</span>)-&gt;<span class="title function_ invoke__">explain</span>()-&gt;<span class="title function_ invoke__">dd</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Illuminate\Support\Collection &#123;<span class="comment">#5344</span></span><br><span class="line">    all: [</span><br><span class="line">        &#123;<span class="comment">#15407</span></span><br><span class="line">            +<span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            +<span class="string">&quot;select_type&quot;</span>: <span class="string">&quot;SIMPLE&quot;</span>,</span><br><span class="line">            +<span class="string">&quot;table&quot;</span>: <span class="string">&quot;books&quot;</span>,</span><br><span class="line">            +<span class="string">&quot;partitions&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;type&quot;</span>: <span class="string">&quot;ALL&quot;</span>,</span><br><span class="line">            +<span class="string">&quot;possible_keys&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;key&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;key_len&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;ref&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            +<span class="string">&quot;rows&quot;</span>: <span class="number">9</span>,</span><br><span class="line">            +<span class="string">&quot;filtered&quot;</span>: <span class="number">11.11111164093</span>,</span><br><span class="line">            +<span class="string">&quot;Extra&quot;</span>: <span class="string">&quot;Using where&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/amit_merchant/status/1432277631320223744">@amit_merchant</a>提供</p>
<h3 id="在-Laravel-中使用doesntExist-方法"><a href="#在-Laravel-中使用doesntExist-方法" class="headerlink" title="在 Laravel 中使用doesntExist()方法"></a>在 Laravel 中使用doesntExist()方法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 一个例子</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="number">0</span> === <span class="variable">$model</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;pending&#x27;</span>)-&gt;<span class="title function_ invoke__">count</span>() ) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我不关心它有多少数据只要它是0</span></span><br><span class="line"><span class="comment">// Laravel 的 exists() 方法会很清晰</span></span><br><span class="line"><span class="keyword">if</span> ( ! <span class="variable">$model</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;pending&#x27;</span>)-&gt;<span class="title function_ invoke__">exists</span>() ) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 但我发现上面这条语句中的！很容易被忽略。</span></span><br><span class="line"><span class="comment">// 那么 doesntExist() 方法会让这个例子更加清晰</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$model</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;pending&#x27;</span>)-&gt;<span class="title function_ invoke__">doesntExist</span>() ) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/ShawnHooper/status/1435686220542234626">@ShawnHooper</a>提供</p>
<h3 id="在一些模型的-boot-方法中自动调用一个特性"><a href="#在一些模型的-boot-方法中自动调用一个特性" class="headerlink" title="在一些模型的 boot () 方法中自动调用一个特性"></a>在一些模型的 boot () 方法中自动调用一个特性</h3><p>如果你有一个特性，你想把它添加到几个模型中，自动调用它们的 <code>boot()</code> 方法，你可以把特性的方法作为boot （特性名称）来调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> <span class="keyword">extends</span>  <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">MultiTenantModelTrait</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">extends</span>  <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">MultiTenantModelTrait</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">MultiTenantModelTrait</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// This method&#x27;s name is boot[TraitName]</span></span><br><span class="line">    <span class="comment">// It will be auto-called as boot() of Transaction/Task</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bootMultiTenantModelTrait</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">static</span>::<span class="title function_ invoke__">creating</span>(function (<span class="variable">$model</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$isAdmin</span>) &#123;</span><br><span class="line">                <span class="variable">$isAdmin</span>-&gt;created_by_id = <span class="title function_ invoke__">auth</span>()-&gt;<span class="title function_ invoke__">id</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Laravel-的-find-方法，比只传一个-ID-更多的选择"><a href="#Laravel-的-find-方法，比只传一个-ID-更多的选择" class="headerlink" title="Laravel 的 find () 方法，比只传一个 ID 更多的选择"></a>Laravel 的 find () 方法，比只传一个 ID 更多的选择</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 在 find($id) 方法中第二个参数可以是返回字段</span></span><br><span class="line"><span class="title class_">Studdents</span>::<span class="title function_ invoke__">find</span>(<span class="number">1</span>, [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;father_name&#x27;</span>]);</span><br><span class="line"><span class="comment">// 这样我们可以查询 ID 为 &#x27;1&#x27; 并返回 name , father_name 字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们可以用数组的方式传递更多的 ID</span></span><br><span class="line"><span class="title class_">Studdents</span>::<span class="title function_ invoke__">find</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;father_name&#x27;</span>]);</span><br><span class="line"><span class="comment">// 输出: ID 为 1,2,3 并返回他们的 name , father_name 字段</span></span><br></pre></td></tr></table></figure>

<h3 id="在-Laravel-中有两种常见的方法来确定一个表是否为空表"><a href="#在-Laravel-中有两种常见的方法来确定一个表是否为空表" class="headerlink" title="在 Laravel 中有两种常见的方法来确定一个表是否为空表"></a>在 Laravel 中有两种常见的方法来确定一个表是否为空表</h3><p>在 Laravel 中，有两种常见的方法来确定一个表是否为空表。 直接在模型上使用 <code>exists()</code> 或者 <code>count()</code><br>不等于一个返回严格的布尔值，另一个返回一个整数，你都可以在条件语句中使用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">\App\Models\User</span>::<span class="title function_ invoke__">exists</span>()) &#123;</span><br><span class="line">        <span class="comment">// returns boolean true or false if the table has any saved rows</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">\App\Models\User</span>::<span class="title function_ invoke__">count</span>()) &#123;</span><br><span class="line">        <span class="comment">// returns the count of rows in the table</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/aschmelyun/status/1440641525998764041">@aschmelyun</a>提供</p>
<h3 id="如何避免-property-of-non-object-错误"><a href="#如何避免-property-of-non-object-错误" class="headerlink" title="如何避免 property of non-object 错误"></a>如何避免 property of non-object 错误</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 设定默认模型</span></span><br><span class="line"><span class="comment">// 假设你有一篇 Post （帖子） 属于一个 Author （作者），代码如下:</span></span><br><span class="line"><span class="variable">$post</span>-&gt;author-&gt;name;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然你可以像这样阻止错误:</span></span><br><span class="line"><span class="variable">$post</span>-&gt;author-&gt;name ?? <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">@<span class="variable">$post</span>-&gt;author-&gt;name</span><br><span class="line"></span><br><span class="line"><span class="comment">// 但你可以在Eloquent关系层面上做到这一点。</span></span><br><span class="line"><span class="comment">// 如果没有作者关联帖子，这种关系将返回一个空的App/Author模型。</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">author</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\Author&#x27;</span>)-&gt;<span class="title function_ invoke__">withDefault</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">author</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsTo</span>(<span class="string">&#x27;App\Author&#x27;</span>)-&gt;<span class="title function_ invoke__">withDefault</span>([</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;Guest Author&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/coderahuljat/status/1440556610837876741">@coderahuljat</a>提供</p>
<h3 id="Eloquent-数据改变后获取原始数据"><a href="#Eloquent-数据改变后获取原始数据" class="headerlink" title="Eloquent 数据改变后获取原始数据"></a>Eloquent 数据改变后获取原始数据</h3><p>Eloquent 模型数据改变后，你可以使用 getOriginal () 方法来获取原始数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">App\User</span>::<span class="title function_ invoke__">first</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;name; <span class="comment">// John</span></span><br><span class="line"><span class="variable">$user</span>-&gt;name = <span class="string">&quot;Peter&quot;</span>; <span class="comment">// Peter</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">getOriginal</span>(<span class="string">&#x27;name&#x27;</span>); <span class="comment">// John</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">getOriginal</span>(); <span class="comment">// Original $user record</span></span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/devThaer/status/1442133797223403521">@devThaer</a>提供</p>
<h3 id="一种更简单创建数据库的方法"><a href="#一种更简单创建数据库的方法" class="headerlink" title="一种更简单创建数据库的方法"></a>一种更简单创建数据库的方法</h3><p>Laravel 还可以使用 .sql 文件来更简单的创建数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">DB::<span class="title function_ invoke__">unprepared</span>(</span><br><span class="line">    <span class="title function_ invoke__">file_get_contents</span>(<span class="keyword">__DIR__</span> . <span class="string">&#x27;./dump.sql&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/w3Nicolas/status/1447902369388249091">@w3Nicolas</a>提供</p>
<h3 id="Query构造器的crossJoinSub方法"><a href="#Query构造器的crossJoinSub方法" class="headerlink" title="Query构造器的crossJoinSub方法"></a>Query构造器的crossJoinSub方法</h3><p>使用CROSS JOIN交叉连接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br><span class="line"><span class="variable">$totalQuery</span> = DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;orders&#x27;</span>)-&gt;<span class="title function_ invoke__">selectRaw</span>(<span class="string">&#x27;SUM(price) as total&#x27;</span>);</span><br><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;orders&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">select</span>(<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">crossJoinSub</span>(<span class="variable">$totalQuery</span>, <span class="string">&#x27;overall&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">selectRaw</span>(<span class="string">&#x27;(price / overall.total) * 100 AS percent_of_total&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/pascalbaljet">@PascalBaljet</a>提供</p>
<h3 id="belongsToMany的中间表命名"><a href="#belongsToMany的中间表命名" class="headerlink" title="belongsToMany的中间表命名"></a>belongsToMany的中间表命名</h3><p>为了决定 关系表的中间表, Eloquent将按字母顺序连接两个相关的型号名称。</p>
<p>这意味着可以这样添加“Post”和“Tag”之间的连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="title class_">Tag</span>::<span class="variable language_">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，您可以自由重写此约定，并且需要在第二个参数中指定联接表。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="title class_">Tag</span>::<span class="variable language_">class</span>, <span class="string">&#x27;posts_tags&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果希望明确说明主键，还可以将其作为第三个和第四个参数提供。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="title class_">Tag</span>::<span class="variable language_">class</span>, <span class="string">&#x27;post_tag&#x27;</span>, <span class="string">&#x27;post_id&#x27;</span>, <span class="string">&#x27;tag_id&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/iammikek">@iammikek</a>提供</p>
<h3 id="根据Pivot字段排序"><a href="#根据Pivot字段排序" class="headerlink" title="根据Pivot字段排序"></a>根据Pivot字段排序</h3><p><code>BelongsToMany::orderByPivot()</code> 允许你直接对<code>BelongsToMany </code>关系查询的结果集进行排序。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;tags&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$table</span> = <span class="string">&#x27;posts&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">belongsToMany</span>(<span class="title class_">Tag</span>::<span class="variable language_">class</span>, <span class="string">&#x27;posts_tags&#x27;</span>, <span class="string">&#x27;post_id&#x27;</span>, <span class="string">&#x27;tag_id&#x27;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">using</span>(<span class="title class_">PostTagPivot</span>::<span class="variable language_">class</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">withTimestamps</span>()</span><br><span class="line">            -&gt;<span class="title function_ invoke__">withPivot</span>(<span class="string">&#x27;flag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostTagPivot</span> <span class="keyword">extends</span> <span class="title">Pivot</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span> = <span class="string">&#x27;posts_tags&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Somewhere in the Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPostTags</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Post</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="variable">$id</span>)-&gt;<span class="title function_ invoke__">tags</span>()-&gt;<span class="title function_ invoke__">orderByPivot</span>(<span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/pascalbaljet">@PascalBaljet</a>提供</p>
<h3 id="从数据库中查询一条记录"><a href="#从数据库中查询一条记录" class="headerlink" title="从数据库中查询一条记录"></a>从数据库中查询一条记录</h3><p><code>sole()</code>方法将会只返回一条匹配标准的记录。如果没找到，将会抛出<code>NoRecordsFoundException</code> 异常。如果发现了多条记录，抛出<code>MultipleRecordsFoundException</code> 异常</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">DB::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;products&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;ref&#x27;</span>, <span class="string">&#x27;#123&#x27;</span>)-&gt;<span class="title function_ invoke__">sole</span>();</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/pascalbaljet">@PascalBaljet</a>提供</p>
<h3 id="记录自动分块"><a href="#记录自动分块" class="headerlink" title="记录自动分块"></a>记录自动分块</h3><p>与<code>each()</code>相同，但是更简单使用。<code>chunks</code>自动将记录分成多块。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">User</span>::<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;name&#x27;</span>)-&gt;<span class="title function_ invoke__">chunkMap</span>(fn (<span class="variable">$user</span>) =&gt; [</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> =&gt; <span class="variable">$user</span>-&gt;id,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$user</span>-&gt;name,</span><br><span class="line">]), <span class="number">25</span>);</span><br></pre></td></tr></table></figure>

<p>由<a target="_blank" rel="noopener" href="https://twitter.com/pascalbaljet">@PascalBaljet</a>提供</p>
<h3 id="定时清理过期记录中的模型"><a href="#定时清理过期记录中的模型" class="headerlink" title="定时清理过期记录中的模型"></a>定时清理过期记录中的模型</h3><p>定期清理过时记录的模型。有了这个特性，Laravel将自动完成这项工作，只需调整内核类中<code>model:prune</code>命令的频率</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Prunable</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Prunable</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the prunable model query.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prunable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&lt;=&#x27;</span>, <span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">subMonth</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，在修剪方法中，可以设置删除模型之前必须执行的操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">pruning</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Removing additional resources,</span></span><br><span class="line">    <span class="comment">// associated with the model. For example, files.</span></span><br><span class="line">    <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;s3&#x27;</span>)-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/pascalbaljet">@PascalBaljet</a>提供</p>
<h3 id="不变的日期和对它们的强制转换"><a href="#不变的日期和对它们的强制转换" class="headerlink" title="不变的日期和对它们的强制转换"></a>不变的日期和对它们的强制转换</h3><p>Laravel 8.53 介绍了<code>immutable_date</code> 和<code>immutable_datetime</code> 将日期转换为Immutable&#96;.</p>
<p>转换成<code>CarbonImmutable </code>，而不是常规的<code>Carbon </code>实例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;date_field&#x27;</span>     =&gt; <span class="string">&#x27;immutable_date&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;datetime_field&#x27;</span> =&gt; <span class="string">&#x27;immutable_datetime&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/pascalbaljet">@PascalBaljet</a>提供</p>
<h3 id="findorfail方法也接收ids数组"><a href="#findorfail方法也接收ids数组" class="headerlink" title="findorfail方法也接收ids数组"></a>findorfail方法也接收ids数组</h3><p>findorfail方法也接收ids数组。若无ids被找到 则失败。</p>
<p>若你想拿到一个模型的集合 并不想检测返回数量为你想得到的数量时很好用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">create</span>([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">create</span>([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">2</span>);</span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">create</span>([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">3</span>]);</span><br><span class="line"><span class="comment">// Retrives the user...</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// Throws a 404 because the user doesn&#x27;t exist...</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="number">99</span>);</span><br><span class="line"><span class="comment">// Retrives all 3 users...</span></span><br><span class="line"><span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">findOrFail</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">// Throws because it is unable to find *all* of the users</span></span><br><span class="line"><span class="title class_">User</span>::<span class="title function_ invoke__">findOrFail</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">99</span>]);</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/timacdonald87/status/1457499557684604930">@timacdonald87</a> 提供</p>
<h3 id="从你的数据库中自动移除模型prunableTrait"><a href="#从你的数据库中自动移除模型prunableTrait" class="headerlink" title="从你的数据库中自动移除模型prunableTrait"></a>从你的数据库中自动移除模型prunableTrait</h3><p>Laravel 8.50新特性:</p>
<p>你可以使用<code>prunable trait</code>从你的数据库中自动移除模型。举例:你可以在几天后永久移除软删除的模型。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SoftDeletes</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add Prunable trait</span></span><br><span class="line">    <span class="keyword">use</span> <span class="title">Prunable</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prunable</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Files matching this query will be pruned</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::<span class="title function_ invoke__">query</span>()-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;deleted_at&#x27;</span>, <span class="string">&#x27;&lt;=&#x27;</span>, <span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">subDays</span>(<span class="number">14</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">pruning</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Remove the file from s3 before deleting the model</span></span><br><span class="line">        <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;s3&#x27;</span>)-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Add PruneCommand to your shedule (app/Console/Kernel.php)</span></span><br><span class="line"><span class="variable">$schedule</span>-&gt;<span class="title function_ invoke__">command</span>(<span class="title class_">PruneCommand</span>::<span class="variable language_">class</span>)-&gt;<span class="title function_ invoke__">daily</span>();</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/Philo01/status/1457626443782008834">@Philo01</a>提供</p>
<h3 id="日期转换"><a href="#日期转换" class="headerlink" title="日期转换"></a>日期转换</h3><p>当标记改变时 原来用布尔值来控制模型的可见性，现在可以使用&#96;&#96;something_at<code> </code>替换。比如 一个产品变成可见:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Migration</span></span><br><span class="line"><span class="title class_">Schema</span>::<span class="title function_ invoke__">table</span>(<span class="string">&#x27;products&#x27;</span>, function (Blueprint <span class="variable">$table</span>) &#123;</span><br><span class="line">    <span class="variable">$table</span>-&gt;<span class="title function_ invoke__">datetime</span>(<span class="string">&#x27;live_at&#x27;</span>)-&gt;<span class="title function_ invoke__">nullable</span>();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// In your model</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">live</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="title function_ invoke__">is_null</span>(<span class="variable">$this</span>-&gt;live_at);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Also in your model</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$dates</span> = [</span><br><span class="line">    <span class="string">&#x27;live_at&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/alexjgarrett/status/1459174062132019212">@alexjgarrett</a>提供</p>
<h3 id="多模型更新插入"><a href="#多模型更新插入" class="headerlink" title="多模型更新插入"></a>多模型更新插入</h3><p><code>upsert()</code>方法将插入&#x2F;更新多个记录。</p>
<ul>
<li>第一个参数数组:要更新&#x2F;插入的值</li>
<li>第二个:查询表达式中使用的唯一标识列</li>
<li>第三个:若记录存在 你想要更新的列</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Flight</span>::<span class="title function_ invoke__">upsert</span>([</span><br><span class="line">    [<span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Oakland&#x27;</span>, <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;San Diego&#x27;</span>, <span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">99</span>],</span><br><span class="line">    [<span class="string">&#x27;departure&#x27;</span> =&gt; <span class="string">&#x27;Chicago&#x27;</span>, <span class="string">&#x27;destination&#x27;</span> =&gt; <span class="string">&#x27;New York&#x27;</span>, <span class="string">&#x27;price&#x27;</span> =&gt; <span class="number">150</span>],</span><br><span class="line">], [<span class="string">&#x27;departure&#x27;</span>, <span class="string">&#x27;destination&#x27;</span>], [<span class="string">&#x27;price&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/mmartin_joo/status/1461591319516647426">@mmartin_joo</a>提供</p>
<h3 id="过滤结果集之后获取查询构造器"><a href="#过滤结果集之后获取查询构造器" class="headerlink" title="过滤结果集之后获取查询构造器"></a>过滤结果集之后获取查询构造器</h3><p>你可以使用 <code>toQuery()</code> 在过滤结果集之后获取查询构造器。</p>
<p>该方法在内部使用集合的第一个模型 并使用集合模型上的“whereKey”比较器。(此处翻译拗口 存疑。但是使用方法很明确。)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Retrieve all logged_in users</span></span><br><span class="line"><span class="variable">$loggedInUsers</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;logged_in&#x27;</span>, <span class="literal">true</span>)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"><span class="comment">// Filter them using a Collection method or php filtering</span></span><br><span class="line"><span class="variable">$nthUsers</span> = <span class="variable">$loggedInUsers</span>-&gt;<span class="title function_ invoke__">nth</span>(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// You can&#x27;t do this on the collection</span></span><br><span class="line"><span class="variable">$nthUsers</span>-&gt;<span class="title function_ invoke__">update</span>(<span class="comment">/* ... */</span>);</span><br><span class="line"><span class="comment">// But you can retrieve the Builder using -&gt;toQuery()</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$nthUsers</span>-&gt;<span class="title function_ invoke__">isNotEmpty</span>()) &#123;</span><br><span class="line">    <span class="variable">$nthUsers</span>-&gt;<span class="title function_ invoke__">toQuery</span>()-&gt;<span class="title function_ invoke__">update</span>(<span class="comment">/* ... */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/RBilloir/status/1462529494917566465">@RBilloir</a>提供</p>
<h3 id="选择聚合计算相关模型"><a href="#选择聚合计算相关模型" class="headerlink" title="选择聚合计算相关模型"></a>选择聚合计算相关模型</h3><p>选择聚合计算相关模型。</p>
<p>需要指出的是在一组相关模型上使用<code>count</code>方法要慢一点。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// In your controller</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">withCount</span>(<span class="string">&#x27;articles&#x27;</span>);</span><br><span class="line"><span class="comment">// Or, to add a constraint to the aggregate</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">withCount</span>([</span><br><span class="line">    <span class="string">&#x27;articles&#x27;</span> =&gt; fn (<span class="variable">$query</span>) =&gt; <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">live</span>();</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// In your view</span></span><br><span class="line"><span class="variable">$user</span>-&gt;articles_count</span><br><span class="line"><span class="comment">// Instead of</span></span><br><span class="line"><span class="variable">$user</span>-&gt;articles-&gt;<span class="title function_ invoke__">count</span>();</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/alexjgarrett/status/1462753602385108995">@alexjgarrett</a>提供</p>
<h3 id="自定义强制转换"><a href="#自定义强制转换" class="headerlink" title="自定义强制转换"></a>自定义强制转换</h3><p>你可以自定义强制转换来让<code>Laravel</code>自动格式化你的模型数据。</p>
<p>下面是一个在检索或更改用户名时将其大写的示例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CapitalizeWordsCast</span> <span class="keyword">implements</span> <span class="title">CastsAttributes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">ucwords</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">ucwords</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>  =&gt; <span class="title class_">CapitalizeWordsCast</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">    ]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/mattkingshott/status/1462828232206659586">@mattkingshott</a>提供</p>
<h3 id="保存中不要触发事件"><a href="#保存中不要触发事件" class="headerlink" title="保存中不要触发事件"></a>保存中不要触发事件</h3><p>若你不想触发模型事件 使用<code>saveQuietly()</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">quietly</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">findOrFail</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$user</span>-&gt;name = <span class="string">&#x27;Martin Joo&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Will not trigger any model event</span></span><br><span class="line">    <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">saveQuietly</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/mmartin_joo/status/1465289689154265091">@mmartin_joo</a>提供</p>
<h3 id="基于相关模型的平均值或总数排序"><a href="#基于相关模型的平均值或总数排序" class="headerlink" title="基于相关模型的平均值或总数排序"></a>基于相关模型的平均值或总数排序</h3><p>你是否曾需要基于关系模型的平均值或总数来排序？</p>
<p>这很简单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bestBooks</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title class_">Book</span>::<span class="title function_ invoke__">query</span>()</span><br><span class="line">        -&gt;<span class="title function_ invoke__">withAvg</span>(<span class="string">&#x27;ratings as average_rating&#x27;</span>, <span class="string">&#x27;rating&#x27;</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">orderByDesc</span>(<span class="string">&#x27;average_rating&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/mmartin_joo/status/1466769691385335815">@mmartin_joo</a>提供</p>
<h3 id="返回事务结果"><a href="#返回事务结果" class="headerlink" title="返回事务结果"></a>返回事务结果</h3><p>若你有一个<code>DB</code>事务 并且你想返回它的结果 至少有两种方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 1. You can pass the parameter by reference</span></span><br><span class="line"><span class="variable">$invoice</span> = <span class="literal">NULL</span>;</span><br><span class="line">DB::<span class="title function_ invoke__">transaction</span>(function () <span class="keyword">use</span> (&amp;$<span class="title">invoice</span>) &#123;</span><br><span class="line">    $<span class="title">invoice</span> = <span class="title">Invoice</span>::<span class="title">create</span>(...);</span><br><span class="line">    <span class="variable">$invoice</span>-&gt;<span class="title function_ invoke__">items</span>()-&gt;<span class="title function_ invoke__">attach</span>(...);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 2. Or shorter: just return trasaction result</span></span><br><span class="line"><span class="variable">$invoice</span> = DB::<span class="title function_ invoke__">transaction</span>(function () &#123;</span><br><span class="line">    <span class="variable">$invoice</span> = <span class="title class_">Invoice</span>::<span class="title function_ invoke__">create</span>(...);</span><br><span class="line">    <span class="variable">$invoice</span>-&gt;<span class="title function_ invoke__">items</span>()-&gt;<span class="title function_ invoke__">attach</span>(...);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$invoice</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="从query中移除多个公共scope"><a href="#从query中移除多个公共scope" class="headerlink" title="从query中移除多个公共scope"></a>从query中移除多个公共scope</h3><p>当使用<code>Global Scopes</code>时 你不仅可以使用多个 <code>scope</code> 而且可以在不需要的时候通过提供的&#96;&#96;withoutGlobalScopes&#96;方法移除他们</p>
<p><a target="_blank" rel="noopener" href="https://laravel.com/docs/8.x/eloquent#global-scopes">Link to docs</a></p>
<h3 id="JSON列属性排序"><a href="#JSON列属性排序" class="headerlink" title="JSON列属性排序"></a>JSON列属性排序</h3><p>你可以使用JSON列属性排序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// JSON column example:</span></span><br><span class="line"><span class="comment">// bikes.settings = &#123;&quot;is_retired&quot;: false&#125;</span></span><br><span class="line"><span class="variable">$bikes</span> = <span class="title class_">Bike</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;athlete_id&#x27;</span>, <span class="variable">$this</span>-&gt;athleteId)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">orderBy</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">orderByDesc</span>(<span class="string">&#x27;settings-&gt;is_retired&#x27;</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">get</span>();</span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/brbcoding/status/1473353537983856643">@brbcoding</a>提供</p>
<h3 id="从第一个结果中获取单列的值"><a href="#从第一个结果中获取单列的值" class="headerlink" title="从第一个结果中获取单列的值"></a>从第一个结果中获取单列的值</h3><p>你可以使用<code>value</code>方法从第一个结果中获取单列的值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Instead of</span></span><br><span class="line"><span class="title class_">Integration</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)-&gt;<span class="title function_ invoke__">first</span>()-&gt;active;</span><br><span class="line"><span class="comment">// You can use</span></span><br><span class="line"><span class="title class_">Integration</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)-&gt;<span class="title function_ invoke__">value</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line"><span class="comment">// or this to throw an exception if no records found</span></span><br><span class="line"><span class="title class_">Integration</span>::<span class="title function_ invoke__">where</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)-&gt;<span class="title function_ invoke__">valueOrFail</span>(<span class="string">&#x27;active&#x27;</span>)<span class="string">&#x27;;</span></span><br></pre></td></tr></table></figure>

<p>由 <a target="_blank" rel="noopener" href="https://twitter.com/justsanjit/status/1475572530215796744">@justsanjit</a>提供</p>
<h3 id="检测模型属性是否被修改"><a href="#检测模型属性是否被修改" class="headerlink" title="检测模型属性是否被修改"></a>检测模型属性是否被修改</h3><p>想知道您对模型所做的更改是否改变了键的值吗？没问题，只需<code>originalIsEquivalent</code>方法即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$user</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">first</span>(); <span class="comment">// [&#x27;name&#x27; =&gt; &quot;John&#x27;]</span></span><br><span class="line"><span class="variable">$user</span>-&gt;name = <span class="string">&#x27;John&#x27;</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">originalIsEquivalent</span>(<span class="string">&#x27;name&#x27;</span>); <span class="comment">// true</span></span><br><span class="line"><span class="variable">$user</span>-&gt;name = <span class="string">&#x27;David&#x27;</span>; <span class="comment">// Set directly</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">fill</span>([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;David&#x27;</span>]); <span class="comment">// Or set via fill</span></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">originalIsEquivalent</span>(<span class="string">&#x27;name&#x27;</span>); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>由 [@mattkingshott]提供</p>
<h3 id="定义访问器与修改器的新方法"><a href="#定义访问器与修改器的新方法" class="headerlink" title="定义访问器与修改器的新方法"></a>定义访问器与修改器的新方法</h3><p>Laravel 8.77:定义访问器与修改器的新方法 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Before, two-method approach</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setTitleAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;attributes[<span class="string">&#x27;title&#x27;</span>] = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTitleAttribute</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// New approach</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">title</span>(<span class="params"></span>): <span class="title">Attribute</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Attribute</span>(</span><br><span class="line">        get: <span class="function"><span class="keyword">fn</span> (<span class="params"><span class="variable">$value</span></span>) =&gt;</span> <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$value</span>),</span><br><span class="line">        set: <span class="function"><span class="keyword">fn</span> (<span class="params"><span class="variable">$value</span></span>) =&gt;</span> <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tip given by <a target="_blank" rel="noopener" href="https://twitter.com/Teacoders/status/1473697808456851466">@Teacoders</a></p>
<h3 id="另外一种定义访问器与修改器的方法"><a href="#另外一种定义访问器与修改器的方法" class="headerlink" title="另外一种定义访问器与修改器的方法"></a>另外一种定义访问器与修改器的方法</h3><p>在一些模型中想用同样的修改器 访问器 可以自定义转换。</p>
<p>只需要创建一个类 实现 &#96;&#96;CastsAttributes&#96; 实现两个方法</p>
<ul>
<li>get 标识模型应当从数据库如何拿到</li>
<li>set 标识数据应当如何存储到数据库</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Casts</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">CastsAttributes</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimestampsCast</span> <span class="keyword">implements</span> <span class="title">CastsAttributes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Carbon</span>::<span class="title function_ invoke__">parse</span>(<span class="variable">$value</span>)-&gt;<span class="title function_ invoke__">diffForHumans</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$model</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Carbon</span>::<span class="title function_ invoke__">parse</span>(<span class="variable">$value</span>)-&gt;<span class="title function_ invoke__">format</span>(<span class="string">&#x27;Y-m-d h:i:s&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后你可以在模型中实现这个转换</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Models</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">User</span> <span class="keyword">as</span> <span class="title">Authenticatable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Casts</span>\<span class="title">TimestampsCast</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The attributes that should be cast.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$casts</span> = [</span><br><span class="line">        <span class="string">&#x27;updated_at&#x27;</span> =&gt; <span class="title class_">TimestampsCast</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="title class_">TimestampsCast</span>::<span class="variable language_">class</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[@AhmedRezk]提供</p>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/2024/03/07/laravel/Validation/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    验证器
                
            </div>
        </a>
    
    
        <a href="/2024/03/07/laravel/Factories/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">工厂</div>
        </a>
    
</nav>





    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     


</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            Gemini &copy; 2025 
        </div>
    </div>
</footer>

        

    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>